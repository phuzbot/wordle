<!DOCTYPE html>
<html>
  <head>
    <style>
      .positionMatch {
        color: green;
      }
      .presenceMatch {
        color: orange;
      }
      .noMatch {
        color: black;
      }
      .noGuess {
        color: gray;
      }
    </style>
  </head>
  <body>
    <div
      id="guessContainer"
      style="
        font-family: 'Lucida Console', monospace;
        text-transform: uppercase;
      "
    ></div>

    <input id="guessInput" type="text" name="txt" value="" />
    <div
      id="keyboardContainer"
      style="
        font-family: 'Lucida Console', monospace;
        text-transform: uppercase;
      "
    ></div>
    <div id="errorMessage"></div>

    <button type="button" onclick="submitGuess()">Submit Guess</button>

    <br />
    <br />
    <div>Code: <input id="wordCode" type="text" name="txt" value="0" /></div>
    <button type="button" onclick="nextWord()">Next Word</button>
    <script>
      const wordLength = 5;

      let word = "hello";
      const keyboard = ["qwertyuiop", "asdfghjkl", "zxcvbnm"];

      let positionMatchLetters = "";
      let presenceMatchLetters = "";
      let noMatchLetters = "";

      let guesses = [];

      let allWords = [];

      var m_w = 123456789;
      var m_z = 987654321;
      var mask = 0xffffffff;

      function seed(i) {
        m_w = (123456789 + i) & mask;
        m_z = (987654321 - i) & mask;
      }

      function random() {
        m_z = (36969 * (m_z & 65535) + (m_z >> 16)) & mask;
        m_w = (18000 * (m_w & 65535) + (m_w >> 16)) & mask;
        var result = ((m_z << 16) + (m_w & 65535)) >>> 0;
        result /= 4294967296;
        return result;
      }

      function shuffle(array) {
        let currentIndex = array.length,
          randomIndex;
        while (currentIndex != 0) {
          randomIndex = Math.floor(random() * currentIndex);
          currentIndex--;
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex],
            array[currentIndex],
          ];
        }
        return array;
      }

      function httpGetAsync(theUrl, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
          if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText);
        };
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.send(null);
      }

      /**
       * @param {string} answer
       * @param {string} guess
       */
      function getMatches(answer, guess) {
        const result = [];
        let nonPositionMatched = "";
        for (let i = 0; i < wordLength; i++) {
          result.push("noMatch");
        }
        for (let i = 0; i < wordLength; i++) {
          noMatchLetters += guess[i];
          if (answer[i] == guess[i]) {
            result[i] = "positionMatch";
            positionMatchLetters += answer[i];
          } else {
            nonPositionMatched += answer[i];
          }
        }
        for (let i = 0; i < wordLength; i++) {
          if (answer[i] == guess[i]) {
            // exact match ignore
          } else if (nonPositionMatched.includes(guess[i])) {
            nonPositionMatched = nonPositionMatched.replace(guess[i], "");
            result[i] = "presenceMatch";
            presenceMatchLetters += guess[i];
          }
        }
        return result;
      }

      function showGuesses() {
        const guessContainer = document.getElementById("guessContainer");
        guessContainer.innerHTML = "";
        positionMatchLetters = "";
        presenceMatchLetters = "";
        noMatchLetters = "";
        for (let i = 0; i < guesses.length; i++) {
          const guess = guesses[i];
          const matches = getMatches(word, guess);
          const wordElement = document.createElement("p");
          guessContainer.appendChild(wordElement);
          for (let j = 0; j < wordLength; j++) {
            const characterElement = document.createElement("span");
            characterElement.innerHTML = guess[j];
            characterElement.classList.add(matches[j]);
            wordElement.appendChild(characterElement);
          }
        }
        const keyboardContainer = document.getElementById("keyboardContainer");
        keyboardContainer.innerHTML = "";
        for (let rowIndex = 0; rowIndex < keyboard.length; rowIndex++) {
          let keyboardRow = keyboard[rowIndex];
          const keyboardRowElement = document.createElement("p");
          keyboardContainer.appendChild(keyboardRowElement);
          for (
            let characterIndex = 0;
            characterIndex < keyboardRow.length;
            characterIndex++
          ) {
            const keyElement = document.createElement("span");
            const characterValue = keyboardRow[characterIndex];
            keyElement.innerHTML = characterValue;
            if (positionMatchLetters.includes(characterValue)) {
              keyElement.classList.add("positionMatch");
            } else if (presenceMatchLetters.includes(characterValue)) {
              keyElement.classList.add("presenceMatch");
            } else if (noMatchLetters.includes(characterValue)) {
              keyElement.classList.add("noMatch");
            } else {
              keyElement.classList.add("noGuess");
            }
            keyboardRowElement.appendChild(keyElement);
          }
        }
      }

      /**
       * @param {string} newGuess
       */
      function submitGuess() {
        const newGuess = document
          .getElementById("guessInput")
          .value.toLowerCase();
        document.getElementById("guessInput").value = "";
        if (!allWords.includes(newGuess)) {
          const errorMessage = document.getElementById("errorMessage");
          errorMessage.innerHTML = newGuess + " is not a word";
          return;
        }
        guesses.push(newGuess);
        showGuesses();
      }

      function nextWord() {
        const wordIndex =
          1 + parseInt(document.getElementById("wordCode").value);
        word = allWords[wordIndex];
        document.getElementById("wordCode").value = wordIndex;
        document.getElementById("guessInput").value = "";
        guesses = [];
        showGuesses();
      }

      async function main() {
        httpGetAsync("words", (/** @type {string} */ v) => {
          let unshuffledAllWords = v.split("\n");
          allWordsLength = allWords.length;
          seed(12345);
          allWords = shuffle(unshuffledAllWords);
          const wordIndex = document.getElementById("wordCode").value;
          word = allWords[wordIndex];
          showGuesses();
        });
      }

      // Execute a function when the user releases a key on the keyboard
      document
        .getElementById("guessInput")
        .addEventListener("keyup", function (event) {
          // Number 13 is the "Enter" key on the keyboard
          if (event.keyCode === 13) {
            submitGuess();
          }
        });
      main();
    </script>
  </body>
</html>
